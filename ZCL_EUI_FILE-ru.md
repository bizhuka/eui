## ZCL_EUI_FILE

Пример декомпозиции обычного метода **DOWNLOAD** или как думать ООП-исто за 1 день

***

### Пример SE38 -> ZEUI_TEST_EXCEL

---

Если у вас есть метод с десятком optional параметров стоит ~~начать чаще курить~~ разделить его на несколько более мелких и понятных методов

Жил-был простой метод **DOWNLOAD** по выгрузке файлов.\
Он принимал 2 параметра __IT_TABLE__ и его длину __IV_LENGTH__.\
Был он совсем не сложный, пока не понадобилась выгрузка из IV_**X**STRING.\
А потом и из обычной строки __IV_STRING__  + кодировка __IV_ENCODING__ (пу UTF-8 но не всегда)

Решил что не плохо бы открывать файл после выгрузки __IV_OPEN__\
Да и иногда надо было открыть его через __OLE__(+1 параметр) для вызова макроса.\
Потом пошла оптимизация выгрузки файлов через FTP для файлов более 10 мегабайт\
Все было хорошо, но потом иногда файлы нужно было загружать в папку указанную пользователем\
или иметь постоянное имя\
или генерировать случайное для выгрузки в sap_tmp

---

По итогу **DOWNLOAD** внутри стал похож на рулон дешевой туатлной бумаги из супермаркета и пользоваться им хотелось все меньше   

Собрав волю в кулак ~~и для начала протерев монитор спиртовым перегаром после недавнего корпоратива~~ было решено разделить его наконец на более мелкие

---

Для начала хранить сам файл проще всего в одном XSTRING атрибуте (и передавать его в конструкторе)

![image](https://user-images.githubusercontent.com/36256417/80464453-40c27c80-8953-11ea-99ae-545095f7c6aa.png)

А вот менять MV_XSTRING можно из разных источников

![image](https://user-images.githubusercontent.com/36256417/80464724-a44caa00-8953-11ea-88e7-85dd847929af.png)

каждый метод возвращает себя в качестве результата

![image](https://user-images.githubusercontent.com/36256417/80464964-f7bef800-8953-11ea-868b-1b9ce63cc315.png)

Это дает возможность вызова следующего метода **DOWNLOAD** (или SHOW) в виде цепочки

![image](https://user-images.githubusercontent.com/36256417/80465232-5be1bc00-8954-11ea-9d4b-af93f9ba04e8.png)

Если после выгрузки ничего делать не надо цепочка вызовов обрывается, иначе можно вызвать 1 из следующих для открытия файла

![image](https://user-images.githubusercontent.com/36256417/80465722-f3dfa580-8954-11ea-981a-ed28670df1a2.png) 

---

По итогу если надо загрузить файл из внутренней таблицы, вызвать окно сохранения файла и потом открыть его\
**цепочка** будет иметь вид  

```abap
 new ZCL_EUI_FILE( )->
    IMPORT_FROM_ITAB( )->
    DOWNLOAD( IV_SAVE_DIALOG = 'X' )->
    OPEN( )
```

Если надо загрузить данные из STRING в кодировке UTF-16LE, выгрузить файл в определенную папку и открыть его через Excel

```abap
 new ZCL_EUI_FILE( )->
    IMPORT_FROM_STRING(  IV_ENCODING = utf_16be )->
    DOWNLOAD( IV_FULL_PATH = ... )->
    OPEN_BY_OLE( )
```

Если в конце его нужно показать внутри SAP GUI inplace меняем DOWNLOAD( ) на **SHOW( )**

```abap
 new ZCL_EUI_FILE( )->
    IMPORT_FROM_STRING(  IV_ENCODING = utf_16be )->
    SHOW( )
```

Каждый из шагов может ~~выбросить~~ ~~выкинуть~~ вызвать исключение или исключения, поэтому лучше его завернуть в **TRY**\
То есть 1 обработчик исключений для всей цепочки вызовов
```abap
    TRY.
        new ZCL_EUI_FILE( )->IMPORT_FROM_STRING(  IV_ENCODING = utf_16be )->DOWNLOAD( IV_FULL_PATH = ... )->OPEN_BY_OLE( ).
    CATCH zcx_eui_exception INTO DATA(lo_error).
        MESSAGE lo_error TYPE 'S' DISPLAY LIKE 'E'.
        RETURN.
    ENDTRY. 
```
